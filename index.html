<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SKOV Humidity Offset – v1.4</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #020617;
      color: #f9fafb;
      margin: 0;
      padding: 16px;
    }
    .version {
      text-align: right;
      font-size: 0.8rem;
      color: #64748b;
      margin-bottom: 6px;
    }
    .card {
      max-width: 900px;
      margin: 0 auto;
      background: #020617;
      padding: 18px;
      border-radius: 14px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.6);
    }
    h1 {
      text-align: center;
      font-size: 1.3rem;
      margin: 0 0 4px;
    }
    .sub {
      text-align: center;
      font-size: 0.85rem;
      color: #9ca3af;
      margin: 0 0 14px;
    }
    label {
      display: block;
      margin-top: 10px;
      font-size: 0.9rem;
    }
    input {
      width: 100%;
      padding: 8px;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #f9fafb;
      box-sizing: border-box;
    }
    .sensor-container {
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
    }
    .sensor-box {
      flex: 1;
      min-width: 280px;
      padding: 14px;
      border-radius: 10px;
      background: #0b1120;
    }
    .sensor-title {
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 1rem;
    }
    button {
      margin-top: 16px;
      width: 100%;
      padding: 10px;
      font-size: 1rem;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 999px;
      cursor: pointer;
    }
    button:active { transform: scale(0.98); }

    .result-block {
      margin-top: 10px;
      padding: 10px;
      border-radius: 10px;
      background: #020617;
      font-size: 0.9rem;
      display: none;
    }
    .offset-value {
      font-size: 1.4rem;
      font-weight: 700;
      margin-top: 6px;
    }
    .chip {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      background: #1d4ed8;
      font-size: 0.75rem;
      margin-bottom: 6px;
    }
    .limit-note {
      margin-top: 4px;
      font-size: 0.8rem;
      color: #f87171;
    }
    .info-box {
      margin-top: 16px;
      padding: 12px;
      border-radius: 10px;
      background: #0b1120;
      font-size: 0.9rem;
      display: none;
    }
    .info-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .conf-high { color: #4ade80; font-weight: 600; }
    .conf-med  { color: #fbbf24; font-weight: 600; }
    .conf-low  { color: #f87171; font-weight: 600; }
  </style>
</head>
<body>

  <div class="version">v1.4 – 29 Nov 2025</div>

  <div class="card">
    <h1>SKOV Humidity Offset</h1>
    <p class="sub">
      Target Fluke humidity • Offset limit ±10 • Auto SKOV≈Fluke+15–20% • Setpoint + Confidence indicator
    </p>

    <label for="desired">Target Fluke humidity (% RH)</label>
    <input id="desired" type="number" step="0.1" value="55" />

    <label for="setpoint">Current SKOV humidity setpoint (% RH)</label>
    <input id="setpoint" type="number" step="0.1" value="70" />

    <div class="sensor-container">
      
      <!-- SENSOR 1 -->
      <div class="sensor-box">
        <div class="sensor-title">Humidity Sensor 1</div>

        <label for="fluke1">Fluke @ Sensor 1 (% RH)</label>
        <input id="fluke1" type="number" step="0.1" />

        <label for="skov1">SKOV Sensor 1 display (% RH)</label>
        <input id="skov1" type="number" step="0.1" />

        <label for="offset1">Current Sensor 1 offset</label>
        <input id="offset1" type="number" step="0.1" />

        <div id="result1" class="result-block">
          <div id="chip1" class="chip"></div>
          <div>Set SKOV humidity offset to:</div>
          <div id="offset1Value" class="offset-value"></div>
          <div id="offset1Change"></div>
          <div id="limit1" class="limit-note"></div>
        </div>
      </div>

      <!-- SENSOR 2 -->
      <div class="sensor-box">
        <div class="sensor-title">Humidity Sensor 2</div>

        <label for="fluke2">Fluke @ Sensor 2 (% RH)</label>
        <input id="fluke2" type="number" step="0.1" />

        <label for="skov2">SKOV Sensor 2 display (% RH)</label>
        <input id="skov2" type="number" step="0.1" />

        <label for="offset2">Current Sensor 2 offset</label>
        <input id="offset2" type="number" step="0.1" />

        <div id="result2" class="result-block">
          <div id="chip2" class="chip"></div>
          <div>Set SKOV humidity offset to:</div>
          <div id="offset2Value" class="offset-value"></div>
          <div id="offset2Change"></div>
          <div id="limit2" class="limit-note"></div>
        </div>
      </div>

    </div><!-- sensor container -->

    <button onclick="calc()">Calculate</button>

    <div id="setpointBox" class="info-box">
      <div class="info-title">Setpoint suggestion</div>
      <div id="setpointText"></div>
    </div>

    <div id="confidenceBox" class="info-box">
      <div class="info-title">Reading confidence</div>
      <div id="confidenceLabel"></div>
      <div id="confidenceDetail"></div>
    </div>

  </div><!-- card -->

  <script>
    // Internal constants
    const MIN_DIFF = 15;     // min SKOV − Fluke (%)
    const MAX_DIFF = 20;     // max SKOV − Fluke (%)
    const OFFSET_LIMIT = 10; // ±10 max offset

    function r1(v) {
      return Math.round(v * 10) / 10;
    }

    // Decide SKOV–Fluke diff between 15 and 20 based on how far Fluke is from target
    function chooseDiff(fluke, desired) {
      const range = MAX_DIFF - MIN_DIFF;
      const error = fluke - desired; // +ve = too humid, -ve = too dry

      if (error <= -5) return MIN_DIFF;   // very dry → use lower diff
      if (error >= 5)  return MAX_DIFF;   // very humid → use higher diff

      // In between -5 and +5 → interpolate smoothly
      const t = (error + 5) / 10;         // -5..+5 → 0..1
      return MIN_DIFF + t * range;
    }

    function calcSensor(fluke, skov, offset, desired,
                        chipEl, valueEl, changeEl, limitEl, boxEl) {
      if (isNaN(fluke) || isNaN(skov) || isNaN(offset)) {
        boxEl.style.display = "none";
        return {
          used: false,
          residual: 0,
          fluke: null,
          skov: null,
          diff: null
        };
      }

      const diff = chooseDiff(fluke, desired);
      const targetSkov = fluke + diff;
      const displayChange = targetSkov - skov;

      const rawNewOffset = offset + displayChange;
      const newOffset = Math.max(-OFFSET_LIMIT, Math.min(OFFSET_LIMIT, rawNewOffset));
      const offsetChange = newOffset - offset;
      const residual = displayChange - offsetChange; // what offset couldn't do

      chipEl.textContent = "Using SKOV ≈ Fluke + " + r1(diff) + "%";
      valueEl.textContent = (newOffset >= 0 ? "+" : "") + r1(newOffset);
      changeEl.textContent =
        "Change from current: " +
        (offsetChange >= 0 ? "+" : "") + r1(offsetChange);

      if (Math.abs(rawNewOffset) > OFFSET_LIMIT + 1e-6) {
        limitEl.textContent =
          "Offset limit ±" + OFFSET_LIMIT +
          "% reached here. Remaining adjustment will be handled via setpoint suggestion.";
      } else {
        limitEl.textContent = "";
      }

      boxEl.style.display = "block";
      return {
        used: true,
        residual: residual,
        fluke: fluke,
        skov: skov,
        diff: skov - fluke
      };
    }

    function calcConfidence(s1, s2) {
      const box = document.getElementById("confidenceBox");
      const label = document.getElementById("confidenceLabel");
      const detail = document.getElementById("confidenceDetail");

      if (!s1.used && !s2.used) {
        box.style.display = "none";
        return;
      }

      let level = "high";
      let reasons = [];

      // Only one sensor used
      if ((s1.used && !s2.used) || (!s1.used && s2.used)) {
        level = "medium";
        reasons.push("Only one sensor has valid readings. No cross-check between sensors.");
      }

      // Both sensors used ⇒ compare
      if (s1.used && s2.used) {
        const flukeGap = Math.abs(s1.fluke - s2.fluke);
        const diffGap  = Math.abs(s1.diff  - s2.diff);

        if (flukeGap > 6 || diffGap > 7) {
          level = "low";
          reasons.push(
            "Large disagreement between sensors: " +
            "Fluke difference " + r1(flukeGap) + "%, " +
            "SKOV–Fluke difference gap " + r1(diffGap) + "%."
          );
        } else if (flukeGap > 3 || diffGap > 4) {
          if (level !== "low") level = "medium";
          reasons.push(
            "Moderate disagreement between sensors: " +
            "Fluke difference " + r1(flukeGap) + "%, " +
            "SKOV–Fluke difference gap " + r1(diffGap) + "%."
          );
        }
      }

      // Residual check (how much we rely on setpoint instead of offsets)
      const residuals = [];
      if (s1.used) residuals.push(Math.abs(s1.residual));
      if (s2.used) residuals.push(Math.abs(s2.residual));

      if (residuals.length > 0) {
        const avgResidual = residuals.reduce((a,b)=>a+b,0) / residuals.length;
        if (avgResidual > 4 && level !== "low") {
          if (level === "high") level = "medium";
          reasons.push(
            "Offsets cannot fully correct SKOV; remaining average adjustment " +
            r1(avgResidual) + "% is handled via setpoint."
          );
        }
      }

      // Build label text
      let labelHtml = "";
      if (level === "high") {
        labelHtml = "<span class='conf-high'>HIGH confidence</span> – sensors agree and corrections are within normal range.";
      } else if (level === "medium") {
        labelHtml = "<span class='conf-med'>MEDIUM confidence</span> – readings are usable, but recheck after adjustments.";
      } else {
        labelHtml = "<span class='conf-low'>LOW confidence</span> – sensor readings disagree. Verify with Fluke before making big changes.";
      }

      box.style.display = "block";
      label.innerHTML = labelHtml;

      if (reasons.length > 0) {
        detail.textContent = reasons.join(" ");
      } else {
        detail.textContent = "No major issues detected between Sensor 1 and Sensor 2 readings.";
      }
    }

    function calc() {
      const desired = parseFloat(document.getElementById("desired").value);
      const setpoint = parseFloat(document.getElementById("setpoint").value);

      if (isNaN(desired) || isNaN(setpoint)) {
        alert("Please fill target Fluke humidity and current setpoint.");
        return;
      }

      const s1 = calcSensor(
        parseFloat(document.getElementById("fluke1").value),
        parseFloat(document.getElementById("skov1").value),
        parseFloat(document.getElementById("offset1").value),
        desired,
        document.getElementById("chip1"),
        document.getElementById("offset1Value"),
        document.getElementById("offset1Change"),
        document.getElementById("limit1"),
        document.getElementById("result1")
      );

      const s2 = calcSensor(
        parseFloat(document.getElementById("fluke2").value),
        parseFloat(document.getElementById("skov2").value),
        parseFloat(document.getElementById("offset2").value),
        desired,
        document.getElementById("chip2"),
        document.getElementById("offset2Value"),
        document.getElementById("offset2Change"),
        document.getElementById("limit2"),
        document.getElementById("result2")
      );

      // Setpoint suggestion from residuals
      const setpointBox  = document.getElementById("setpointBox");
      const setpointText = document.getElementById("setpointText");
      const residuals = [];
      if (s1.used && Math.abs(s1.residual) > 1e-6) residuals.push(s1.residual);
      if (s2.used && Math.abs(s2.residual) > 1e-6) residuals.push(s2.residual);

      if (residuals.length === 0) {
        setpointBox.style.display = "block";
        setpointText.textContent =
          "No setpoint adjustment needed. Keep SKOV humidity setpoint at " +
          r1(setpoint) + " % after setting the new offsets.";
      } else {
        const avgResidual = residuals.reduce((a,b)=>a+b,0) / residuals.length;
        const newSetpoint = setpoint + avgResidual;
        setpointBox.style.display = "block";
        setpointText.textContent =
          "Current setpoint: " + r1(setpoint) + " %. " +
          "Suggested new setpoint: " + r1(newSetpoint) +
          " % to help the house stabilise around " + r1(desired) +
          " % on the Fluke once offsets are set.";
      }

      // Confidence indicator
      calcConfidence(s1, s2);
    }
  </script>

</body>
</html>
